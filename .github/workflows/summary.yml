name: First Contributor

on:
  issues:
    types: [opened]
  pull_request_target:
    types: [opened]

permissions:
  issues: write
  pull-requests: write

jobs:
  welcome:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const item = context.payload.issue || context.payload.pull_request;
            const author = item.user.login;

            const { data: items } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: author,
              state: 'all'
            });

            if (items.length === 1) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: item.number,
                labels: ['first-time-contributor']
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: item.number,
                body: 'Welcome @' + author + '! Thanks for your first contribution!'
              });
            }
            };

            for (const [label, keywords] of Object.entries(keywordLabels)) {
              if (keywords.some(kw => text.includes(kw))) {
                labels.push(`ðŸ·ï¸ ${label}`);
                console.log(`ðŸ“Œ Auto-labeled as: ${label}`);
              }
            }

            // Component detection
            if (isPR) {
              const { data: files } = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: item.number
              });
              
              const components = new Set();
              files.forEach(file => {
                if (file.filename.startsWith('spotify-frontend/')) {
                  components.add('ðŸ“¦ frontend');
                } else if (file.filename.startsWith('spotify-backend/')) {
                  components.add('ðŸ“¦ backend');
                } else if (file.filename.startsWith('spotify-admin/')) {
                  components.add('ðŸ“¦ admin');
                }
                
                // Detect testing changes
                if (file.filename.includes('test') || file.filename.includes('spec')) {
                  components.add('ðŸ§ª testing');
                }
              });
              
              labels.push(...Array.from(components));
              console.log(`ðŸ“¦ Components detected: ${Array.from(components).join(', ')}`);
            }

            // Apply labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: item.number,
              labels: labels
            });

            console.log(`âœ… Applied labels: ${labels.join(', ')}`);

            // Welcome message
            const welcomeMessage = '## ðŸŽ‰ Welcome to Spotify Full-Stack, @' + author + '!\n\n' +
              'Thank you for your first contribution! We\'re excited to have you in our community! ðŸŽµ\n\n' +
              (isPR ? 
                '### ðŸš€ Your Pull Request\n\n' +
                'We appreciate you taking the time to submit a PR! Here\'s what happens next:\n\n' +
                '1. âœ… **Automated checks** will run to ensure code quality\n' +
                '2. ðŸ‘€ **Code review** by a maintainer (typically within 24-48 hours)\n' +
                '3. ðŸ’¬ **Feedback** - we may ask questions or suggest changes\n' +
                '4. ðŸŽŠ **Merge** - once approved, your code becomes part of the project!\n\n' +
                '**ðŸ’¡ Tips for a smooth review:**\n' +
                '- Keep your changes focused and well-documented\n' +
                '- Respond to feedback promptly\n' +
                '- Don\'t hesitate to ask questions!\n\n'
              : 
                '### ðŸ› Your Issue\n\n' +
                'Thanks for reporting this! A maintainer will review it soon.\n\n' +
                '**What you can do while waiting:**\n' +
                '- âœ… Ensure you\'ve provided all necessary details\n' +
                '- ðŸ” Search for similar existing issues\n' +
                '- ðŸ’¬ Feel free to add more context in comments\n\n'
              ) +
              '### ðŸ“š Helpful Resources\n\n' +
              '- ðŸ“– [README](../README.md) - Project overview and setup\n' +
              '- ðŸ¤ [Contributing Guidelines](../CONTRIBUTING.md) - How to contribute\n' +
              '- ðŸ’¬ [Discussions](../../discussions) - General questions and ideas\n' +
              '- ðŸ› [Issue Tracker](../../issues) - Bug reports and feature requests\n\n' +
              '### ðŸ·ï¸ Auto-Applied Labels\n\n' +
              'We\'ve automatically labeled your contribution:\n' +
              labels.map(l => '- ' + l).join('\n') + '\n\n' +
              '---\n\n' +
              '**Questions?** Feel free to ask in the comments. We\'re here to help! ðŸŽµ\n\n' +
              '*Happy coding!* âœ¨';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: item.number,
              body: welcomeMessage
            });

            console.log('âœ… Welcome message posted');

            // Create summary
            core.summary
              .addHeading('ðŸŽ‰ First-Time Contributor Detected!', 2)
              .addRaw('\n**User**: @' + author + '\n')
              .addRaw('**Type**: ' + (isIssue ? 'Issue' : 'Pull Request') + '\n')
              .addRaw('**Number**: #' + item.number + '\n')
              .addRaw('**Labels**: ' + labels.join(', ') + '\n')
              .write();
