name: Security Scan

run-name: üîí Security scan for ${{ github.ref_name || 'scheduled check' }}

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scan every Monday at 9 AM UTC
    - cron: "0 9 * * 1"

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest

    strategy:
      matrix:
        project: [spotify-backend, spotify-admin, spotify-frontend]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Install dependencies
        working-directory: ./${{ matrix.project }}
        run: npm ci

      - name: Run npm audit
        working-directory: ./${{ matrix.project }}
        run: |
          npm audit --audit-level=moderate || true
          echo "Security scan completed for ${{ matrix.project }}"
        continue-on-error: true

      - name: Check for outdated packages
        working-directory: ./${{ matrix.project }}
        run: npm outdated || true
        continue-on-error: true

  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential secrets..."

          # Check for common secret patterns
          if grep -r "api_key\|apikey\|secret\|password\|token" --include="*.js" --include="*.jsx" . | grep -v node_modules | grep -v ".git" | grep -E "(=|:)\s*['\"][^'\"]{20,}"; then
            echo "‚ö†Ô∏è  Warning: Potential hardcoded secrets found"
            exit 1
          else
            echo "‚úÖ No obvious hardcoded secrets detected"
          fi
        continue-on-error: true

      - name: Check .env files are not committed
        run: |
          if git ls-files | grep -E "\.env$" | grep -v ".env.example"; then
            echo "‚ö†Ô∏è  Warning: .env files are committed. Ensure they don't contain sensitive data."
            echo "Consider using .env.example templates instead."
          else
            echo "‚úÖ No .env files committed"
          fi
        continue-on-error: true
