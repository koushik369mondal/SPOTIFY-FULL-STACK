name: Project Auto

on:
  issues:
    types: [opened, closed]
  pull_request:
    types: [opened, closed]

permissions:
  issues: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const action = context.payload.action;
            const num = context.payload.issue?.number || context.payload.pull_request?.number;
            const status = action === 'opened' ? 'Todo' : 'Done';
            console.log('#' + num + ' -> ' + status);
            const action = context.payload.action;

            console.log(`ðŸ” Processing ${isIssue ? 'issue' : 'PR'} #${item.number}`);
            console.log(`ðŸ“Œ Action: ${action}`);

            let targetStatus = null;

            // Determine target status based on action
            if (action === 'opened') {
              targetStatus = 'Todo';
              console.log('ðŸ“ New item â†’ Todo');
            } else if (action === 'assigned') {
              targetStatus = 'In Progress';
              console.log('ðŸ‘¤ Assigned â†’ In Progress');
            } else if (action === 'closed') {
              if (isPR && item.merged) {
                targetStatus = 'Done';
                console.log('âœ… PR merged â†’ Done');
              } else if (isPR && !item.merged) {
                targetStatus = 'Cancelled';
                console.log('âŒ PR closed without merge â†’ Cancelled');
              } else {
                targetStatus = 'Done';
                console.log('âœ… Issue closed â†’ Done');
              }
            } else if (action === 'reopened') {
              targetStatus = 'In Progress';
              console.log('ðŸ”„ Reopened â†’ In Progress');
            } else if (action === 'converted_to_draft') {
              targetStatus = 'In Progress';
              console.log('ðŸš§ Converted to draft â†’ In Progress');
            } else if (action === 'ready_for_review') {
              targetStatus = 'Review';
              console.log('ðŸ‘€ Ready for review â†’ Review');
            }

            if (!targetStatus) {
              console.log('â­ï¸ No status update needed for this action');
              return;
            }

            // Try to update project board (V2)
            try {
              // Note: GitHub Projects V2 requires GraphQL API and more complex setup
              // This is a simplified example - actual implementation would need:
              // 1. Project ID
              // 2. Field IDs for status column
              // 3. GraphQL mutations
              
              console.log(`ðŸŽ¯ Target status: ${targetStatus}`);
              console.log('ðŸ’¡ For full Projects V2 automation, configure project ID and field IDs');
              
              // Add comment to track status
              const statusEmoji = {
                'Todo': 'ðŸ“',
                'In Progress': 'ðŸš€',
                'Review': 'ðŸ‘€',
                'Done': 'âœ…',
                'Cancelled': 'âŒ'
              };
              
              const comment = `${statusEmoji[targetStatus]} **Project Status**: Moved to **${targetStatus}**`;
              
              // Only add comment for significant state changes
              if (['opened', 'assigned', 'closed', 'ready_for_review'].includes(action)) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: item.number,
                  body: comment
                });
                console.log('ðŸ’¬ Status comment added');
              }
              
            } catch (error) {
              console.log(`âš ï¸ Could not update project board: ${error.message}`);
              console.log('ðŸ’¡ Make sure project automation is properly configured');
            }

            // Classic Projects support (if using classic boards)
            try {
              // Get project columns
              const projects = await github.rest.projects.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              if (projects.data.length > 0) {
                console.log(`ðŸ“Š Found ${projects.data.length} classic project(s)`);
                
                // This would require additional logic to:
                // 1. Find the card for this issue/PR
                // 2. Determine the target column
                // 3. Move the card
                
                console.log('ðŸ’¡ Classic project automation requires additional configuration');
              }
            } catch (error) {
              console.log('â„¹ï¸ No classic projects or insufficient permissions');
            }

            console.log('âœ… Project automation completed');

      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸ“‹ Project Board Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”¢ Item: #${{ github.event.issue.number || github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Œ Action: ${{ github.event.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ• Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Note**: For full Projects V2 automation, configure project and field IDs in repository secrets." >> $GITHUB_STEP_SUMMARY
